### Partie 02 - *Architecture du TP2 : Haute Disponibilité avec Keepalived*

---

### **Présentation**

L’exercice pratique repose sur une infrastructure réseau visant à configurer et tester une solution de haute disponibilité en utilisant **Keepalived** pour gérer une **VIP (Virtual IP)** et une **VGW (Virtual Gateway)**. La configuration est basée sur des machines virtuelles connectées à différents réseaux virtuels (**VMnet**) pour simuler un environnement réaliste.

---

### 01 - **Diagramme de l’Architecture**

```
                            +----------------+
                            |     CLIENT      |
                            |  Windows 10 Pro |
                            |-----------------|
                            | VMnet3 (NAT)    |
                            | DHCP            |
                            +-----------------+
                                   |
                          +--------------------+
                          |      Routeur       |
                          |     (PfSense)      |
                          +--------------------+
                         NIC1: NAT (Internet)
                         NIC2: VMnet3 (20.21.22.1/24)
                         NIC3: VMnet2 (10.11.12.254/24)
                                   |
             +---------------------+---------------------+
             |                                           |
  +--------------------+                    +-----------------------+
  |      Master         |                    |        Backup        |
  |    Ubuntu Server    |                    |    Ubuntu Server     |
  |---------------------|                    |----------------------|
  | NIC1: VMnet2 (10.11.12.1/24)            | NIC1: VMnet2 (10.11.12.2/24)
  | NIC2: VMnet4 (192.168.100.1/24)         | NIC2: VMnet4 (192.168.100.2/24)
  | NIC3: VMnet5 (172.168.1.1/30)           | NIC3: VMnet5 (172.168.1.2/30)
  +--------------------+                    +-----------------------+
           |                                             |
    +--------------------+                    +-----------------------+
    |      Noeud1        |                    |         Noeud2        |
    |    Ubuntu Server    |                    |    Ubuntu Server     |
    |---------------------|                    |----------------------|
    | NIC1: VMnet4 (192.168.100.10/24)        | NIC1: VMnet4 (192.168.100.20/24)
    | Default GW: 192.168.100.99              | Default GW: 192.168.100.99
    +--------------------+                    +-----------------------+
```

---

### 02 - **Tableau des Rôles et Adresses IP**

| **Nom**      | **Réseau (VMnet)** | **Adresse IP**       | **Rôle**                         | **Fonctionnalités**                                 |
|--------------|--------------------|----------------------|-----------------------------------|----------------------------------------------------|
| **PfSense**  | VMnet3 (LAN)       | 20.21.22.1/24        | Routeur, DNS, NAT                | Assure le routage entre les réseaux.              |
|              | VMnet2 (DMZ)       | 10.11.12.254/24      |                                   |                                                    |
| **Master**   | VMnet2 (DMZ)       | 10.11.12.1/24        | Directeur Principal               | Gère la VIP et VGW pour les nœuds.                |
|              | VMnet4 (Backend)   | 192.168.100.1/24     |                                   |                                                    |
|              | VMnet5 (Sync)      | 172.168.1.1/30       | Synchronisation                  | Synchronisation Keepalived avec le Backup.        |
| **Backup**   | VMnet2 (DMZ)       | 10.11.12.2/24        | Directeur Secondaire             | Prend le relais en cas de panne du Master.        |
|              | VMnet4 (Backend)   | 192.168.100.2/24     |                                   |                                                    |
|              | VMnet5 (Sync)      | 172.168.1.2/30       | Synchronisation                  | Synchronisation Keepalived avec le Master.        |
| **Noeud1**   | VMnet4 (Backend)   | 192.168.100.10/24    | Serveur Réel                     | Héberge des services web.                         |
| **Noeud2**   | VMnet4 (Backend)   | 192.168.100.20/24    | Serveur Réel                     | Héberge des services web.                         |
| **VGW**      | VMnet4 (Backend)   | 192.168.100.99/24    | Passerelle Virtuelle             | Assure le routage des requêtes Backend.           |
| **VIP**      | VMnet2 (DMZ)       | 10.11.12.99/24       | Virtual IP                       | Adresse virtuelle pour les directeurs Keepalived. |

---

### 03 - **Description des Réseaux**

1. **VMnet3 (Interne - LAN) :**
   - Connecte le Client et le Routeur.
   - Assure l’accès Internet via NAT.

2. **VMnet2 (DMZ) :**
   - Connecte les Directeurs (Master et Backup) et le Routeur.
   - Héberge la **VIP (10.11.12.99)**, qui distribue le trafic.

3. **VMnet4 (Backend) :**
   - Connecte les Directeurs et les Nœuds.
   - Héberge la **VGW (192.168.100.99)** pour assurer la communication.

4. **VMnet5 (Synchronisation) :**
   - Connecte le Master et le Backup uniquement.
   - Permet la synchronisation privée via Keepalived.

---

### Partie 02 - *QUESTIONS*

---

#### **01. Pourquoi utiliser des réseaux VMnet distincts dans cette architecture ?**

**Réponse :**
- Pour isoler les flux (Interne, DMZ, Backend, et Synchronisation).
- Évite les conflits de trafic.
- Renforce la sécurité en séparant les rôles (ex. : DMZ pour le trafic public, Backend pour les services internes).

---

#### **02. Expliquez le rôle de la Virtual IP (VIP) dans cette architecture.**

**Réponse :**
- La VIP (10.11.12.99) représente l’adresse publique du cluster.
- Elle distribue les requêtes entrantes entre les Directeurs Master et Backup.
- En cas de panne, Keepalived bascule automatiquement la VIP vers le serveur fonctionnel.

---

#### **03. Quelle est la fonction de la VGW (192.168.100.99) dans le réseau Backend ?**

**Réponse :**
- La VGW est la passerelle virtuelle utilisée par les nœuds Backend.
- Elle redirige le trafic des nœuds vers les Directeurs Master/Backup, selon leur disponibilité.

---

#### **04. Pourquoi un réseau dédié (VMnet5) est-il nécessaire pour la synchronisation ?**

**Réponse :**
- Permet de sécuriser les données de synchronisation entre le Master et le Backup.
- Empêche les perturbations dues au trafic DMZ ou Backend.

---

#### **05. Pourquoi est-il important que les nœuds Backend utilisent la VGW comme passerelle ?**

**Réponse :**
- Cela garantit que le trafic est routé via les Directeurs (Master/Backup).
- Assure une haute disponibilité même en cas de panne d’un Directeur.

---

#### **06. Si un nœud ne peut pas pinguer la VGW, quelles vérifications effectueriez-vous ?**

**Réponse :**
1. Vérifiez la configuration IP du nœud :
   ```bash
   ip route
   ```
2. Assurez-vous que la VGW est active sur le Master ou le Backup.
3. Vérifiez la connectivité réseau sur VMnet4.

---

#### **07. Expliquez pourquoi le Routeur est connecté à plusieurs réseaux VMnet.**

**Réponse :**
- **VMnet3 :** Assure l’accès Internet via NAT.
- **VMnet2 :** Connecte le réseau DMZ pour gérer le trafic des Directeurs.
- Permet le routage entre les réseaux et l’accès à Internet.

---

#### **08. Pourquoi est-il nécessaire d’attribuer des adresses IP fixes aux machines ?**

**Réponse :**
- Assure une communication stable entre les machines.
- Permet à Keepalived de fonctionner correctement avec les VIP et VGW.
- Simplifie le dépannage et la gestion réseau.

---

#### **09. Si le Client ne peut pas accéder à la VIP, quelles étapes de diagnostic effectueriez-vous ?**

**Réponse :**
1. Pingez la VIP (10.11.12.99) depuis le Client.
2. Vérifiez que le Master gère la VIP (commande `ip addr show`).
3. Testez la connectivité entre le Client et VMnet3.

---

#### **10. Expliquez comment Keepalived gère le basculement entre Master et Backup.**

**Réponse :**
- Keepalived utilise le protocole VRRP pour surveiller la disponibilité des Directeurs.
- Si le Master tombe en panne, le Backup prend en charge la VIP et la VGW.































#### **11. Quel est le rôle de la synchronisation entre le Master et le Backup dans Keepalived ?**

**Réponse :**
- La synchronisation garantit que le Backup dispose des informations nécessaires pour prendre la relève en cas de panne du Master.
- Permet de répliquer l’état de la configuration, y compris la gestion de la VIP et de la VGW.

---

#### **12. Si la VIP n’apparaît pas sur le Master, quelles vérifications devez-vous effectuer ?**

**Réponse :**
1. Assurez-vous que le service Keepalived est actif :
   ```bash
   sudo systemctl status keepalived
   ```
2. Vérifiez la configuration de Keepalived (`/etc/keepalived/keepalived.conf`) pour la déclaration de la VIP.
3. Assurez-vous que l’interface réseau associée à la VIP est active (commande `ip addr show`).

---

#### **13. Pourquoi est-il important que la VIP soit sur le même réseau que les adresses des Directeurs ?**

**Réponse :**
- La VIP doit être sur le même réseau (VMnet2 - DMZ) que les adresses des Directeurs pour que le trafic soit routé correctement.
- Si elle est sur un autre réseau, les clients ne pourront pas atteindre les serveurs.

---

#### **14. Pourquoi les Nœuds (Backend) ne sont-ils pas directement exposés à la DMZ ?**

**Réponse :**
- Les Nœuds Backend hébergent les services réels, mais ils ne sont accessibles qu’indirectement via les Directeurs.
- Cela renforce la sécurité et permet aux Directeurs de gérer la haute disponibilité via la VGW.

---

#### **15. Expliquez le rôle de VRRP dans Keepalived.**

**Réponse :**
- VRRP (Virtual Router Redundancy Protocol) est utilisé pour élire dynamiquement un Directeur principal (Master) et un secondaire (Backup).
- Il permet de basculer automatiquement la VIP et la VGW vers le Backup si le Master devient indisponible.

---

#### **16. Que se passe-t-il si deux machines revendiquent simultanément la VIP ?**

**Réponse :**
- Un conflit d’adresse IP se produit, entraînant des erreurs réseau.
- VRRP permet de gérer ce scénario en s’assurant qu’un seul Directeur peut posséder la VIP à la fois.

---

#### **17. Quelle commande utiliseriez-vous pour vérifier si la VGW est active sur le Master ?**

**Réponse :**
```bash
ip addr show
```
- Vous devriez voir l’adresse IP virtuelle (VGW : 192.168.100.99) attribuée à l’interface Backend du Master.

---

#### **18. Pourquoi les Nœuds utilisent-ils une passerelle virtuelle (VGW) au lieu d’un Directeur spécifique ?**

**Réponse :**
- La VGW permet de rediriger le trafic Backend vers le Directeur actif (Master ou Backup).
- Cela garantit que le trafic continue à fonctionner en cas de panne d’un Directeur.

---

#### **19. Quels tests effectueriez-vous pour vérifier la connectivité sur VMnet4 (Backend) ?**

**Réponse :**
1. **Ping entre les Nœuds et la VGW** :
   - Depuis Noeud1, testez :
     ```bash
     ping 192.168.100.99
     ```
2. **Ping entre les Nœuds et les Directeurs** :
   - Depuis Noeud1, testez :
     ```bash
     ping 192.168.100.1
     ```
   - Depuis Noeud2, testez :
     ```bash
     ping 192.168.100.2
     ```

---

#### **20. Si la synchronisation entre Master et Backup échoue, quelles étapes suivriez-vous pour résoudre le problème ?**

**Réponse :**
1. Vérifiez la connectivité sur le réseau de synchronisation (VMnet5) entre Master et Backup :
   ```bash
   ping 172.168.1.2
   ```
2. Vérifiez les journaux de Keepalived sur les deux machines pour identifier les erreurs :
   ```bash
   sudo tail -f /var/log/syslog
   ```
3. Assurez-vous que la configuration de Keepalived inclut bien la directive `vrrp_instance` avec les mêmes identifiants sur les deux Directeurs.

---

### Section Bonus : **Scénarios Pratiques**

#### **21. Scénario :**
Le client peut pinger la VIP (10.11.12.99) mais ne peut pas accéder aux services des Nœuds. Quelle pourrait être la cause ?

**Réponse :**
- La VGW (192.168.100.99) n’est pas active ou configurée correctement.
- Les Nœuds n’ont pas la VGW comme passerelle par défaut.
- Les services web sur les Nœuds ne fonctionnent pas ou sont mal configurés.

---

#### **22. Scénario :**
Après avoir arrêté le Master, le Backup ne prend pas la VIP. Que vérifiez-vous ?

**Réponse :**
1. Vérifiez que le service Keepalived est actif sur le Backup.
2. Vérifiez la priorité du Backup dans la configuration Keepalived (elle doit être inférieure à celle du Master).
3. Testez la connectivité sur le réseau de synchronisation (VMnet5).

---

#### **23. Scénario :**
Les Nœuds peuvent pinguer la VGW, mais le client ne peut pas accéder aux services hébergés. Quelles vérifications effectueriez-vous ?

**Réponse :**
1. Assurez-vous que les services web sur les Nœuds fonctionnent correctement.
2. Vérifiez que le routage est activé sur les Directeurs pour rediriger le trafic du réseau DMZ vers le Backend.












