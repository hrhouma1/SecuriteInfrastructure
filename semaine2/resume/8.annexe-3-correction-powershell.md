Voici un README détaillé intitulé "Correction" avec des explications approfondies sur les scripts PowerShell utilisés pour l'automatisation des exercices. L'annexe à la fin fournit des explications détaillées sur chaque script et ses fonctions.

---

# Correction

## Introduction

Ce document a pour but de fournir une correction détaillée des exercices pratiques relatifs à l'utilisation des outils Sysinternals pour la détection d'activités suspectes et l'analyse d'un système compromis. Les scripts PowerShell fournis dans ce README automatisent les différentes étapes nécessaires à l'accomplissement de ces tâches, offrant ainsi un moyen rapide et reproductible de réaliser ces analyses.

## Objectifs

Les objectifs principaux de cette correction sont :
1. Installer et configurer Sysmon pour surveiller les activités système sur une machine virtuelle sous Windows 10.
2. Simuler une activité suspecte sur le système et capturer les événements associés.
3. Utiliser Process Monitor (et son équivalent via Sysmon dans PowerShell) pour surveiller les modifications du registre.
4. Analyser un système compromis et documenter les résultats dans un rapport d'incident détaillé.

## Prérequis

- Machine virtuelle sous Windows 10.
- Hyperviseur comme VirtualBox ou VMware pour l'installation de la machine virtuelle.
- Connaissances de base en PowerShell.
- Accès Internet pour télécharger les outils nécessaires.

## Installation et Configuration

### Étape 1 : Installer Sysmon

Commencez par télécharger et installer Sysmon sur votre machine virtuelle. Le script suivant automatise cette tâche :

```powershell
# Variables
$sysmonUrl = "https://download.sysinternals.com/files/Sysmon.zip"
$sysmonZip = "C:\Tools\Sysmon.zip"
$sysmonDir = "C:\Tools\Sysmon"
$sysmonConfig = "C:\Tools\sysmonconfig-export.xml"

# Téléchargement de Sysmon
Invoke-WebRequest -Uri $sysmonUrl -OutFile $sysmonZip

# Extraction de Sysmon
Expand-Archive -Path $sysmonZip -DestinationPath $sysmonDir

# Installation de Sysmon avec le fichier de configuration
Start-Process -FilePath "$sysmonDir\Sysmon.exe" -ArgumentList "-accepteula -i $sysmonConfig" -NoNewWindow -Wait
```

### Étape 2 : Configurer Sysmon avec un Fichier Personnalisé

Appliquez une configuration personnalisée pour une meilleure surveillance des événements :

```powershell
# Téléchargement du fichier de configuration personnalisé
$customConfigUrl = "https://raw.githubusercontent.com/SwiftOnSecurity/sysmon-config/master/sysmonconfig-export.xml"
Invoke-WebRequest -Uri $customConfigUrl -OutFile $sysmonConfig

# Appliquer la configuration personnalisée
Start-Process -FilePath "$sysmonDir\Sysmon.exe" -ArgumentList "-c $sysmonConfig" -NoNewWindow -Wait
```

### Étape 3 : Simuler une Activité Suspecte

Simulez une activité suspecte en créant un fichier dans un répertoire système à l'aide de PowerShell :

```powershell
$maliciousFile = "C:\Windows\System32\malicious.txt"
New-Item -Path $maliciousFile -ItemType "file" -Value "This is a malicious file"
```

### Étape 4 : Vérifier les Événements dans l'Event Viewer

Analysez les événements capturés par Sysmon pour identifier l'activité suspecte :

```powershell
Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" | Select-Object -First 10 | Format-List
```

## Utilisation de Process Monitor et Analyse

### Étape 5 : Simuler une Modification du Registre

Utilisez un script PowerShell pour simuler une modification malveillante du registre :

```powershell
$regPath = "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run"
$regName = "MaliciousApp"
$regValue = "C:\MaliciousApp.exe"

# Modification du registre
Set-ItemProperty -Path $regPath -Name $regName -Value $regValue
```

### Étape 6 : Filtrer les Événements Capturés

Utilisez Sysmon pour capturer les événements de modification du registre :

```powershell
$filteredEvents = Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -FilterXPath "*[System[EventID=13]]" | Select-Object -First 10
$filteredEvents | Format-List
```

### Étape 7 : Générer un Rapport d'Incident

Compilez les informations collectées dans un rapport détaillé :

```powershell
$incidentReport = @"
Résumé de l'Incident:
- Simulation d'une infection par malware en créant un fichier dans le répertoire système.
- Utilisation de Sysmon pour capturer et analyser les événements.

Outils Utilisés:
- Sysmon pour la surveillance des processus et des modifications système.

Résultats:
- Fichier malveillant détecté: $maliciousFile
- Modifications système capturées dans les journaux Sysmon.

Recommandations:
- Améliorer les politiques de sécurité pour éviter la persistance des malwares via le registre.
- Mettre en place des règles de détection supplémentaires dans Sysmon.
"@
$incidentReport | Out-File "C:\Tools\Incident_Report.txt"
```

## Conclusion

Ce README vous a guidé dans l'automatisation des tâches de configuration, de simulation et d'analyse en utilisant PowerShell. Chaque étape a été conçue pour vous fournir un aperçu pratique des outils Sysinternals et de leur application dans la détection des activités suspectes et la réponse aux incidents.

---

# **Annexe : Explications Détaillées des Scripts PowerShell**

### **Script d'Installation et de Configuration de Sysmon**

- **Téléchargement de Sysmon** : Le script utilise `Invoke-WebRequest` pour télécharger l'archive ZIP contenant Sysmon. L'archive est ensuite extraite à l'aide de `Expand-Archive` dans le répertoire spécifié.
  
- **Installation de Sysmon** : Sysmon est installé avec une configuration par défaut ou personnalisée en utilisant `Start-Process` pour exécuter la commande avec les arguments appropriés. Le flag `-accepteula` est utilisé pour accepter automatiquement les termes de la licence.

### **Script de Configuration Personnalisée de Sysmon**

- **Fichier de configuration personnalisé** : Le script télécharge un fichier de configuration optimisé pour la détection d'événements critiques, comme ceux fournis par SwiftOnSecurity. Ce fichier ajuste les paramètres de Sysmon pour une surveillance plus précise.

### **Script de Simulation d'Activité Suspecte**

- **Création d'un fichier suspect** : Un fichier est créé dans le répertoire `System32` pour simuler une activité suspecte. Cette action est typique des malwares qui tentent de déposer des fichiers dans des répertoires critiques pour compromettre le système.

### **Script de Vérification des Événements Sysmon**

- **Analyse des événements** : `Get-WinEvent` est utilisé pour interroger les logs Sysmon dans l'Event Viewer. Les événements pertinents sont sélectionnés et formatés pour une inspection manuelle ou automatisée.

### **Script de Simulation de Modification du Registre**

- **Modification du registre** : Le script modifie une clé de registre essentielle pour simuler un malware qui s'inscrit au démarrage de Windows. Cela montre comment les malwares persistent sur un système compromis.

### **Script de Filtrage et d'Analyse des Événements**

- **Filtrage des événements Sysmon** : Le script capture et filtre les événements associés aux modifications du registre pour se concentrer sur les actions malveillantes potentielles, en utilisant l'Event ID spécifique pour les modifications de registre.

### **Script de Génération de Rapport d'Incident**

- **Rapport d'incident** : Ce script compile les informations collectées dans un rapport structuré. Il résume l'incident, décrit les outils utilisés, analyse les résultats, et propose des recommandations pour améliorer la sécurité du système.

---

Ce README fournit une correction complète et détaillée, tout en offrant des explications approfondies dans l'annexe pour chaque étape du processus automatisé. Vous pouvez utiliser ce document comme guide pour comprendre et reproduire les analyses décrites, tout en renforçant vos compétences en PowerShell et en sécurité informatique.
