### 5. Atelier Pratique

Cet atelier est conçu pour vous permettre d'appliquer les concepts théoriques abordés dans les sections précédentes. Les exercices suivants vous guideront pas à pas dans la configuration des outils Sysinternals, la détection d'activités suspectes, et l'analyse d'un système compromis. À la fin de chaque exercice, vous serez en mesure de documenter et de rapporter vos découvertes de manière structurée.

#### **Préambule : Choix du Système d'Exploitation**

Pour ces exercices, il est recommandé de commencer par une machine virtuelle sous **Windows 10** en raison de sa simplicité d'accès et de configuration. Cependant, si vous souhaitez approfondir et appliquer ces concepts dans un environnement serveur, une annexe est disponible avec des instructions spécifiques pour **Windows Server 2019**.

#### **Exercice 1 : Configurer Sysmon sur une Machine Virtuelle et Détecter une Activité Anormale**

**Objectif :**
Installer et configurer Sysmon sur une machine virtuelle pour surveiller les activités système. L'objectif est d'identifier une activité anormale, telle que la création d'un processus inhabituel ou une connexion réseau suspecte.

**Étapes :**

1. **Création d'une Machine Virtuelle :**
   - **Outil recommandé :** Utilisez un hyperviseur comme VirtualBox ou VMware pour créer une machine virtuelle.
   - **Système d'exploitation :** Installez Windows 10 sur la machine virtuelle.
   - **Configuration réseau :** Assurez-vous que la machine virtuelle est connectée à un réseau pour permettre la simulation d'activités réseau.

2. **Installation de Sysmon :**
   - **Téléchargement :** Téléchargez Sysmon depuis le site officiel de [Sysinternals](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon).
   - **Installation :** Ouvrez une invite de commande en tant qu'administrateur et exécutez la commande suivante pour installer Sysmon :
     ```bash
     sysmon.exe -accepteula -i sysmonconfig-export.xml
     ```
   - **Explication :** Cette commande accepte automatiquement l'accord de licence utilisateur final (EULA) et installe Sysmon en utilisant le fichier de configuration par défaut `sysmonconfig-export.xml`.

3. **Configuration Personnalisée de Sysmon :**
   - **Téléchargement du fichier de configuration :** Utilisez un fichier de configuration personnalisé tel que celui disponible sur GitHub [SwiftOnSecurity Sysmon Config](https://github.com/SwiftOnSecurity/sysmon-config).
   - **Application de la configuration :** Pour appliquer cette configuration, utilisez la commande suivante :
     ```bash
     sysmon.exe -c chemin\vers\sysmonconfig-export.xml
     ```
   - **Explication :** Ce fichier de configuration permet de surveiller des événements spécifiques tels que la création de processus, les connexions réseau, et les modifications de fichiers, en fonction des besoins spécifiques de l'entreprise.

4. **Détection d'une Activité Anormale :**
   - **Simuler une activité suspecte :** 
     - Pour cela, vous pouvez exécuter un script PowerShell malveillant qui crée un fichier texte dans un répertoire système.
     - **Exemple de script PowerShell :**
       ```powershell
       # Ce script crée un fichier texte dans le répertoire système de Windows
       $path = "C:\Windows\System32\malicious.txt"
       New-Item -Path $path -ItemType "file" -Value "This is a malicious file"
       ```
     - **Instructions :**
       1. Ouvrez PowerShell en tant qu'administrateur sur votre machine virtuelle.
       2. Copiez-collez le script ci-dessus dans la console PowerShell.
       3. Exécutez le script pour créer un fichier suspect.

   - **Vérification avec la Visionneuse d'événements (Event Viewer) :**
     - Ouvrez l'Event Viewer en tapant `eventvwr.msc` dans la boîte de dialogue **Exécuter** (`Win + R`).
     - Naviguez vers **Applications and Services Logs > Microsoft > Windows > Sysmon/Operational** pour examiner les événements générés par Sysmon.
     - **Points à rechercher :** Vous devriez voir des événements indiquant la création du fichier texte et l'exécution du script PowerShell. Les événements liés à la création de processus et à l'accès aux fichiers doivent être surveillés.

5. **Documentation :**
   - **Rapport :** Notez les événements détectés, notamment ceux liés à l'activité anormale. Incluez des captures d'écran des journaux Sysmon pertinents et décrivez l'efficacité de Sysmon dans la détection de cette activité.

#### **Exercice 2 : Utiliser Process Monitor pour Suivre l'Activité d'un Processus Malveillant Simulé**

**Objectif :**
Utiliser Process Monitor pour surveiller et analyser l'activité d'un processus malveillant simulé. Cet exercice vous permettra de comprendre comment Process Monitor capture les événements en temps réel et comment filtrer les informations pertinentes.

**Étapes :**

1. **Lancement de Process Monitor :**
   - **Téléchargement :** Téléchargez Process Monitor depuis le site officiel de [Sysinternals](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon).
   - **Exécution :** Exécutez **procmon.exe** en tant qu'administrateur sur votre machine virtuelle Windows 10.
   - **Enregistrement des événements :** Assurez-vous que l'enregistrement des événements est activé (il l'est par défaut lors du lancement de Process Monitor).

2. **Simulation d'un Processus Malveillant :**
   - **Script PowerShell Malveillant :** Utilisez le script suivant pour simuler un processus malveillant qui modifie une clé de registre importante :
     ```powershell
     # Ce script modifie une clé de registre critique de Windows
     Set-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "MaliciousApp" -Value "C:\MaliciousApp.exe"
     ```
     - **Instructions :**
       1. Ouvrez PowerShell en tant qu'administrateur.
       2. Copiez-collez le script ci-dessus dans la console PowerShell.
       3. Exécutez le script pour ajouter une entrée au registre qui simule un programme malveillant au démarrage.

3. **Filtrage des Événements :**
   - **Filtrer les événements de modification du registre :**
     - Cliquez sur **Filter** dans Process Monitor et ajoutez un filtre pour **Operation** est **RegSetValue**.
     - **Explication :** Ce filtre vous permet de concentrer l'affichage sur les événements où des valeurs de registre sont définies ou modifiées, ce qui est pertinent pour notre script.

4. **Analyse des Détails du Processus :**
   - **Examiner les événements capturés :**
     - Identifiez l'événement lié à la modification de la clé de registre effectuée par le script PowerShell.
     - **Vérification des détails :** Notez le chemin du registre modifié, la valeur ajoutée, et le processus responsable de cette modification.

5. **Documentation :**
   - **Rapport :** Rédigez un rapport détaillant les étapes suivies pour simuler l'activité malveillante, les événements capturés par Process Monitor, et une analyse de l'impact potentiel de cette activité sur le système.

#### **Exercice 3 : Analyser une Machine Infectée avec les Outils Sysinternals et Rédiger un Rapport d'Incident**

**Objectif :**
Appliquer l'ensemble des outils Sysinternals (Process Explorer, Autoruns, etc.) pour analyser une machine virtuelle simulant une infection par malware. L'exercice se termine par la rédaction d'un rapport d'incident complet.

**Étapes :**

1. **Préparation de la Machine Virtuelle :**
   - **Simulation de l'infection :**
     - Téléchargez et exécutez un fichier de démonstration de malware ou configurez manuellement une machine virtuelle pour inclure des signes d'infection, tels que des processus inconnus au démarrage.
     - **Note importante :** Utilisez uniquement des échantillons de malware sécurisés et contrôlés, ou créez des scénarios manuellement pour éviter tout dommage accidentel à votre système.

2. **Analyse avec Process Explorer :**
   - **Lancer Process Explorer :**
     - Exécutez **Process Explorer** en tant qu'administrateur.
   - **Examiner les processus actifs :**
     - Recherchez des processus qui utilisent une quantité anormale de ressources CPU ou mémoire.
     - **Vérification des signatures numériques :** Faites un clic droit sur un processus suspect et sélectionnez **Properties**, puis vérifiez si le fichier exécutable est signé par un éditeur de confiance.

3. **Analyse avec Autoruns :**
   - **Examen des programmes de démarrage :**
     - Exécutez **Autoruns** en tant qu'administrateur.
     - Parcourez les différents onglets (Logon, Services, Scheduled Tasks) pour identifier les programmes qui se lancent automatiquement.
     - **Désactivation des entrées suspectes :** Décochez toute entrée inconnue ou suspecte liée à l'infection présumée.

4. **Évaluation des Modifications Système avec Process Monitor :**
   - **Suivi des activités suspect

es :**
     - Utilisez **Process Monitor** pour capturer les modifications en temps réel apportées par les processus malveillants, tels que l'écriture de fichiers ou la modification du registre.
   - **Capture des événements :** Filtrez les événements pour ne visualiser que ceux liés aux actions malveillantes suspectées.

5. **Rédaction du Rapport d'Incident :**
   - **Résumé de l'Incident :**
     - Décrivez le scénario d'infection, y compris les symptômes observés et les impacts sur la machine.
   - **Outils Utilisés :**
     - Listez les outils Sysinternals utilisés pour l'analyse et expliquez comment chaque outil a contribué à l'investigation.
   - **Résultats :**
     - Détaillez les processus suspects identifiés, les modifications système détectées, et les étapes de correction prises.
   - **Recommandations :**
     - Fournissez des conseils pour prévenir de futures infections et améliorer la sécurité du système.

### **Annexe : Adaptation pour Windows Server 2019**

Pour ceux qui souhaitent appliquer ces concepts dans un environnement **Windows Server 2019**, suivez les mêmes étapes que celles décrites ci-dessus avec des adaptations spécifiques pour le serveur. Vous pourrez également explorer des fonctionnalités supplémentaires telles que les rôles serveur, les services de domaine Active Directory, et les politiques de sécurité avancées qui sont pertinentes dans un environnement serveur. Les instructions spécifiques pour Windows Server 2019 sont disponibles dans cette annexe.

### Conclusion

Ces exercices pratiques vous offrent une expérience concrète et approfondie de l'utilisation des outils Sysinternals pour détecter, analyser, et répondre à des incidents de sécurité sur des systèmes Windows. En suivant ces étapes détaillées, vous développerez des compétences essentielles pour gérer les menaces de manière proactive et efficace.
